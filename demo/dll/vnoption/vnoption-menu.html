<!DOCTYPE html>
<html>
<head>
<meta charset="windows-1252">
<title>Options</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
  width: 250px; height: 278px;
  overflow: hidden;
  font-family: 'MS Sans Serif', 'Microsoft Sans Serif', Tahoma, sans-serif;
  font-size: 8pt;
  user-select: none;
}

/* Fond metallique bleu */
.panel {
  position: absolute;
  width: 250px; height: 278px;
  background: url('background.bmp') no-repeat;
  display: none;
}
.panel.active { display: block; }

/* Boutons sur image */
.menu-btn {
  position: absolute;
  left: 23px;
  width: 204px; height: 26px;
  background: url('btn_normal.bmp') no-repeat;
  background-size: 204px 26px;
  border: none;
  cursor: pointer;
  color: #fff;
  font-family: 'MS Sans Serif', 'Microsoft Sans Serif', Tahoma, sans-serif;
  font-size: 8pt;
  font-weight: normal;
  text-align: center;
  line-height: 26px;
  outline: none;
}
.menu-btn:hover, .menu-btn:focus {
  background-image: url('btn_hover.bmp');
}
.menu-btn:active {
  background-image: url('btn_hover.bmp');
  padding-top: 1px;
}

/* Panel Volume */
.vol-label {
  position: absolute;
  left: 12px; top: 14px;
  color: #000;
  font-size: 8pt;
}
.vol-slider {
  position: absolute;
  left: 18px; top: 32px;
  width: 216px; height: 20px;
  accent-color: #4466aa;
}
.vol-value {
  position: absolute;
  left: 77px; top: 58px;
  width: 90px; height: 14px;
  color: #000;
  font-size: 8pt;
  text-align: center;
}
.vol-close {
  position: absolute;
  left: 23px; top: 90px;
}

/* Panel Save/Load */
.save-list {
  position: absolute;
  left: 18px; top: 18px;
  width: 210px; height: 192px;
  background: #fff;
  border: 1px inset #888;
  overflow-y: auto;
  font-size: 8pt;
}
.save-list .item {
  padding: 3px 6px;
  cursor: pointer;
  border-bottom: 1px solid #ddd;
}
.save-list .item:hover { background: #cce; }
.save-list .item.selected { background: #4466aa; color: #fff; }
.save-list .empty { color: #888; padding: 8px; font-style: italic; }

.save-ok {
  position: absolute;
  left: 30px; top: 230px;
}
.save-cancel {
  position: absolute;
  left: 140px; top: 230px;
}

/* Confirm dialog */
.confirm-overlay {
  position: absolute;
  top: 0; left: 0;
  width: 250px; height: 278px;
  background: rgba(0,0,0,0.5);
  display: none;
  z-index: 10;
}
.confirm-box {
  position: absolute;
  top: 80px; left: 25px;
  width: 200px;
  background: #c0c0c0;
  border: 2px outset #ddd;
  padding: 16px;
  text-align: center;
  font-size: 9pt;
}
.confirm-box .confirm-btns {
  margin-top: 14px;
  display: flex;
  justify-content: center;
  gap: 16px;
}
.confirm-box button {
  min-width: 70px;
  padding: 3px 12px;
  font-size: 8pt;
  cursor: pointer;
}
</style>
</head>
<body>

<!-- Panel 1: Menu Principal -->
<div id="panelMenu" class="panel active">
  <button class="menu-btn" style="top:21px" onclick="onNewGame()">Nouvelle partie</button>
  <button class="menu-btn" style="top:72px" onclick="onLoad()">Charger une partie...</button>
  <button class="menu-btn" style="top:104px" onclick="onSave()">Sauvegarder la partie...</button>
  <button class="menu-btn" style="top:150px" onclick="showPanel('panelVolume')">Volume sonore...</button>
  <button class="menu-btn" style="top:197px" onclick="onClose()">Revenir au jeu en cours</button>
  <button class="menu-btn" style="top:231px" onclick="onQuit()">Quitter le jeu</button>
</div>

<!-- Panel 2: Volume -->
<div id="panelVolume" class="panel">
  <span class="vol-label">Volume sonore :</span>
  <input type="range" id="volSlider" class="vol-slider" min="0" max="100" value="100"
         oninput="onVolumeChange(this.value)">
  <span id="volValue" class="vol-value">100%</span>
  <button class="menu-btn vol-close" onclick="showPanel('panelMenu')">Fermer</button>
</div>

<!-- Panel 3: Charger -->
<div id="panelLoad" class="panel">
  <div id="loadList" class="save-list"></div>
  <button class="menu-btn save-ok" style="width:80px" onclick="doLoad()">OK</button>
  <button class="menu-btn save-cancel" style="width:80px" onclick="showPanel('panelMenu')">Annuler</button>
</div>

<!-- Panel 4: Sauvegarder -->
<div id="panelSave" class="panel">
  <div id="saveList" class="save-list"></div>
  <button class="menu-btn save-ok" style="width:80px" onclick="doSave()">OK</button>
  <button class="menu-btn save-cancel" style="width:80px" onclick="showPanel('panelMenu')">Annuler</button>
</div>

<!-- Confirmation overlay -->
<div id="confirmOverlay" class="confirm-overlay">
  <div class="confirm-box">
    <div id="confirmText"></div>
    <div class="confirm-btns">
      <button onclick="confirmYes()">OK</button>
      <button onclick="confirmNo()">Annuler</button>
    </div>
  </div>
</div>

<script>
// Communication avec le moteur VN
var onCommandCallback = null;
var vnoption = {
  setOnCommand: function(cb) { onCommandCallback = cb; }
};
window.vnoption = vnoption;

function sendCommand(cmd) {
  console.log('VNOption command:', cmd);
  if (onCommandCallback) onCommandCallback(cmd);
  else if (window.__vnCommand) window.__vnCommand(cmd);
  else if (parent && parent !== window) {
    try { parent.handleDllCommand(cmd); } catch(e) {}
  }
}

// Navigation entre panels
function showPanel(id) {
  document.querySelectorAll('.panel').forEach(function(p) { p.classList.remove('active'); });
  document.getElementById(id).classList.add('active');
  if (id === 'panelVolume') initVolume();
}

// Confirmation dialog
var pendingConfirm = null;
function showConfirm(text, callback) {
  document.getElementById('confirmText').textContent = text;
  document.getElementById('confirmOverlay').style.display = 'block';
  pendingConfirm = callback;
}
function confirmYes() {
  document.getElementById('confirmOverlay').style.display = 'none';
  if (pendingConfirm) pendingConfirm(true);
  pendingConfirm = null;
}
function confirmNo() {
  document.getElementById('confirmOverlay').style.display = 'none';
  if (pendingConfirm) pendingConfirm(false);
  pendingConfirm = null;
}

// === Fermer (revenir au jeu) ===
function onClose() {
  sendCommand('closedll');
}

// === Quitter le jeu ===
function onQuit() {
  showConfirm('Quitter le jeu ?', function(yes) {
    if (yes) {
      sendCommand('closedll');
      sendCommand('quit');
    }
  });
}

// === Nouvelle partie ===
function onNewGame() {
  showConfirm('Commencer une nouvelle partie ?\nLa progression en cours sera perdue.', function(yes) {
    if (yes) {
      sendCommand('closedll');
      // Reinitialiser : retour au frontal (start)
      sendCommand('runprj frontal\\start.vnp 1');
    }
  });
}

// === Volume ===
function initVolume() {
  // Lire le volume actuel depuis le parent
  var vol = 100;
  try {
    if (parent && parent.masterVolume !== undefined) {
      vol = Math.round(parent.masterVolume * 100);
    }
  } catch(e) {}
  document.getElementById('volSlider').value = vol;
  document.getElementById('volValue').textContent = vol + '%';
}

function onVolumeChange(val) {
  document.getElementById('volValue').textContent = val + '%';
  try {
    if (parent && parent !== window) {
      parent.masterVolume = val / 100;
      // Appliquer aux audio en cours
      var audios = parent.audioElements || {};
      Object.keys(audios).forEach(function(k) {
        if (audios[k] && !audios[k].paused) {
          audios[k].volume = val / 100;
        }
      });
    }
  } catch(e) {}
}

// === Sauvegarde / Chargement (localStorage) ===
var SAVE_PREFIX = 'europeo_save_';
var MAX_SLOTS = 10;
var selectedSlot = -1;

function getSaves() {
  var saves = [];
  for (var i = 0; i < MAX_SLOTS; i++) {
    var raw = localStorage.getItem(SAVE_PREFIX + i);
    if (raw) {
      try {
        var s = JSON.parse(raw);
        saves.push({ slot: i, date: s.date || '?', name: s.name || 'Partie ' + (i+1), data: s });
      } catch(e) {
        saves.push({ slot: i, date: '?', name: 'Partie ' + (i+1) + ' (corrompue)', data: null });
      }
    } else {
      saves.push({ slot: i, date: null, name: null, data: null });
    }
  }
  return saves;
}

function renderSaveList(listId, allowEmpty) {
  var list = document.getElementById(listId);
  list.innerHTML = '';
  selectedSlot = -1;
  var saves = getSaves();
  saves.forEach(function(s) {
    var div = document.createElement('div');
    div.className = 'item';
    if (s.data) {
      var d = s.date ? new Date(s.date).toLocaleString('fr-FR') : '?';
      div.textContent = 'Emplacement ' + (s.slot+1) + ' - ' + d;
    } else if (allowEmpty) {
      div.textContent = 'Emplacement ' + (s.slot+1) + ' - (vide)';
    } else {
      div.textContent = 'Emplacement ' + (s.slot+1) + ' - (vide)';
      div.style.color = '#aaa';
    }
    div.onclick = function() {
      if (!allowEmpty && !s.data) return;
      list.querySelectorAll('.item').forEach(function(it) { it.classList.remove('selected'); });
      div.classList.add('selected');
      selectedSlot = s.slot;
    };
    list.appendChild(div);
  });
}

function onSave() {
  renderSaveList('saveList', true);
  showPanel('panelSave');
}

function onLoad() {
  renderSaveList('loadList', false);
  showPanel('panelLoad');
}

function doSave() {
  if (selectedSlot < 0) return;
  try {
    var gameVars = {};
    var scenePath = '';
    var sceneIndex = 0;
    var basePath = '';
    if (parent && parent !== window) {
      gameVars = JSON.parse(JSON.stringify(parent.gameVars || {}));
      sceneIndex = parent.currentSceneIndex || 0;
      basePath = parent.currentBasePath || '';
      if (parent.currentVNDEntry) scenePath = parent.currentVNDEntry.name || '';
    }
    var saveData = {
      date: new Date().toISOString(),
      name: 'Partie ' + (selectedSlot+1),
      gameVars: gameVars,
      sceneIndex: sceneIndex,
      basePath: basePath,
      scenePath: scenePath
    };
    localStorage.setItem(SAVE_PREFIX + selectedSlot, JSON.stringify(saveData));
    showPanel('panelMenu');
  } catch(e) {
    console.error('Save failed:', e);
  }
}

function doLoad() {
  if (selectedSlot < 0) return;
  var raw = localStorage.getItem(SAVE_PREFIX + selectedSlot);
  if (!raw) return;
  try {
    var s = JSON.parse(raw);
    // Restaurer les variables
    if (parent && parent !== window && s.gameVars) {
      // Vider les variables actuelles
      Object.keys(parent.gameVars).forEach(function(k) { delete parent.gameVars[k]; });
      // Restaurer les variables sauvegardees
      Object.keys(s.gameVars).forEach(function(k) {
        parent.gameVars[k] = s.gameVars[k];
      });
      sendCommand('defcursor 0');
      sendCommand('closedll');
      // Naviguer vers la scene sauvegardee
      if (s.scenePath && s.basePath) {
        var vnpPath = s.basePath + s.scenePath.replace(/\.vnd$/i, '.vnp');
        sendCommand('runprj ' + vnpPath + ' ' + (s.sceneIndex + 1));
      }
    }
  } catch(e) {
    console.error('Load failed:', e);
  }
}
</script>
</body>
</html>
